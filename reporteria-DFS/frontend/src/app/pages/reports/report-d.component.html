<mat-card>
  <mat-card-title>Reporte D: Citas y Atenciones</mat-card-title>
  <mat-card-content>
    <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filter-form">
      <mat-form-field appearance="outline">
        <mat-label>Fecha Inicio</mat-label>
        <input matInput type="date" formControlName="start_date" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Fecha Fin</mat-label>
        <input matInput type="date" formControlName="end_date" />
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="loading">
        <mat-icon>search</mat-icon>
        Aplicar Filtros
      </button>
    </form>
    <div *ngIf="loading" class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
    <mat-card *ngIf="error" class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error }}</p>
      </mat-card-content>
    </mat-card>
    <div *ngIf="!loading && data.length">
      <table mat-table [dataSource]="data" class="full-width-table">
        <ng-container matColumnDef="appointment_id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let row">{{ row.appointment_id }}</td>
        </ng-container>
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let row">{{ row.date }}</td>
        </ng-container>
        <ng-container matColumnDef="time">
          <th mat-header-cell *matHeaderCellDef>Hora</th>
          <td mat-cell *matCellDef="let row">{{ row.time }}</td>
        </ng-container>
        <ng-container matColumnDef="status_label">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let row">{{ row.status_label }}</td>
        </ng-container>
        <ng-container matColumnDef="client">
          <th mat-header-cell *matHeaderCellDef>Cliente</th>
          <td mat-cell *matCellDef="let row">{{ row.client.full_name }}</td>
        </ng-container>
        <ng-container matColumnDef="stylist">
          <th mat-header-cell *matHeaderCellDef>Estilista</th>
          <td mat-cell *matCellDef="let row">{{ row.stylist.name }}</td>
        </ng-container>
        <ng-container matColumnDef="has_attention">
          <th mat-header-cell *matHeaderCellDef>¿Atención?</th>
          <td mat-cell *matCellDef="let row">{{ row.has_attention ? 'Sí' : 'No' }}</td>
        </ng-container>
        <ng-container matColumnDef="total_amount">
          <th mat-header-cell *matHeaderCellDef>Monto</th>
          <td mat-cell *matCellDef="let row">{{ row.total_amount }}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      <div class="summary" *ngIf="summary">
        <p><strong>Total citas:</strong> {{ summary.total_appointments }}</p>
        <p><strong>Atendidas:</strong> {{ summary.attended }}</p>
        <p><strong>Pendientes:</strong> {{ summary.pending }}</p>
        <p><strong>Tasa de atención:</strong> {{ summary.attendance_rate }}%</p>
      </div>
      <button mat-stroked-button color="accent" (click)="exportCSV()">
        <mat-icon>download</mat-icon>
        Exportar CSV
      </button>
    </div>
  </mat-card-content>
</mat-card>
